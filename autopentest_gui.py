import customtkinter as ctk
import threading
import datetime
import os
from PIL import Image

COLOR_FONDO = "#171718"
COLOR_HEADER_BG = "#121213"
COLOR_ACENTO = "#2596be"
COLOR_TARJETA = "#1F1F21"

try:
    import nmap
    LIB_NMAP_INSTALLED = True
except ImportError:
    LIB_NMAP_INSTALLED = False

class PortScanner:
    def __init__(self):
        self.nm = None
        if LIB_NMAP_INSTALLED:
            try:
                self.nm = nmap.PortScanner()
            except Exception:
                self.nm = None

    def scan(self, target, intense=False):
        res = {"target": target, "data": {}, "status": "error"}
        if not self.nm: return res
        
        args = '-T4 -F'
        if intense: args = '-T4 -A -v'
        
        try:
            self.nm.scan(target, arguments=args)
            if target not in self.nm.all_hosts(): return res
            
            host_data = {}
            for proto in self.nm[target].all_protocols():
                ports = []
                for p in sorted(self.nm[target][proto].keys()):
                    info = self.nm[target][proto][p]
                    svc = info.get('product', info.get('name', 'unknown'))
                    ver = info.get('version', '')
                    full_svc = f"{svc} {ver}".strip()
                    
                    risk = ""
                    if p in [21, 23]: risk = "CRÍTICO"
                    elif p == 80: risk = "ALERTA"
                    
                    ports.append({"port": p, "state": info['state'], "service": full_svc, "risk": risk})
                host_data[proto] = ports
            res["data"] = host_data
            res["status"] = "success"
        except: pass
        return res

class AutoPentestWindow(ctk.CTkToplevel):
    def __init__(self, parent):
        super().__init__(parent)
        self.title("KINIX - AutoPentest")
        self.geometry("950x700")
        self.configure(fg_color=COLOR_FONDO)
        self.attributes("-topmost", True)
        self.after(200, lambda: self.attributes("-topmost", False))
        self.focus_force()

        try: self.iconphoto(False, ctk.tkinter.PhotoImage(file="resc/vn.png"))
        except: pass
        
        self.scanner = PortScanner()
        self.last_results = {}

        self.grid_columnconfigure(0, weight=1)
        self.grid_rowconfigure(2, weight=1)

        self.header = ctk.CTkFrame(self, height=80, fg_color=COLOR_HEADER_BG, corner_radius=0)
        self.header.grid(row=0, column=0, sticky="ew")
        title = ctk.CTkFrame(self.header, fg_color="transparent")
        title.pack(side="left", padx=20, pady=20)
        ctk.CTkLabel(title, text="AutoPentest", font=("Roboto", 24, "bold"), text_color="white").pack(side="left")
        
        try:
            pil_img = ctk.CTkImage(light_image=Image.open("resc/logo h.png"), dark_image=Image.open("resc/logo h.png"), size=(150, 40))
            ctk.CTkLabel(self.header, text="", image=pil_img).pack(side="right", padx=20)
        except: pass

        self.input_f = ctk.CTkFrame(self, fg_color="transparent")
        self.input_f.grid(row=1, column=0, sticky="ew", padx=20, pady=20)
        self.entry = ctk.CTkEntry(self.input_f, placeholder_text="Target IP", width=250)
        self.entry.pack(side="left")
        
        self.sw_intense = ctk.CTkSwitch(self.input_f, text="MODO INTENSO", progress_color="#FF3D00")
        self.sw_intense.pack(side="left", padx=15)
        
        self.btn = ctk.CTkButton(self.input_f, text="AUDITAR", fg_color=COLOR_ACENTO, width=120, command=self.start)
        self.btn.pack(side="left", padx=10)
        self.btn_log = ctk.CTkButton(self.input_f, text="GUARDAR LOG", width=120, fg_color="#2B2B2B", command=self.save)
        self.btn_log.pack(side="left")
        self.lbl_st = ctk.CTkLabel(self.input_f, text="")
        self.lbl_st.pack(side="left", padx=10)

        self.scroll = ctk.CTkScrollableFrame(self, fg_color="#121213")
        self.scroll.grid(row=2, column=0, sticky="nsew", padx=20, pady=(0, 20))

    def start(self):
        t = self.entry.get().strip()
        if not t: return
        if self.scanner.nm is None:
            self.lbl_st.configure(text="ERROR: NMAP FALTANTE", text_color="#FF5555")
            return

        for w in self.scroll.winfo_children(): w.destroy()
        self.btn.configure(state="disabled")
        self.lbl_st.configure(text="EJECUTANDO...", text_color=COLOR_ACENTO)
        mode = (self.sw_intense.get() == 1)
        threading.Thread(target=self.run, args=(t, mode)).start()

    def run(self, t, mode):
        res = self.scanner.scan(t, mode)
        self.after(0, lambda: self.show(res))

    def show(self, res):
        self.btn.configure(state="normal")
        self.last_results = res
        if res["status"] == "error":
            self.lbl_st.configure(text="SIN RESPUESTA", text_color="#FF5555")
            ctk.CTkLabel(self.scroll, text="Host inalcanzable o error de red.", text_color="gray").pack(pady=20)
            return
        
        self.lbl_st.configure(text="FINALIZADO", text_color="#00E676")
        data = res["data"]
        if not data:
            ctk.CTkLabel(self.scroll, text="No se detectaron puertos abiertos.").pack(pady=20)
            return

        for proto, ports in data.items():
            ctk.CTkLabel(self.scroll, text=f"Protocolo {proto.upper()}", font=("Roboto", 16, "bold"), text_color="white").pack(pady=10, anchor="w")
            for p in ports:
                row = ctk.CTkFrame(self.scroll, fg_color=COLOR_TARJETA)
                row.pack(fill="x", pady=2)
                ctk.CTkLabel(row, text=f"{p['port']}", width=60, font=("Roboto", 14, "bold")).pack(side="left", padx=10)
                ctk.CTkLabel(row, text=p['state'].upper(), width=80, text_color="#00E676").pack(side="left")
                ctk.CTkLabel(row, text=p['service'], width=200, text_color="gray", anchor="w").pack(side="left")
                if p['risk']:
                    ctk.CTkLabel(row, text=f"⚠️ {p['risk']}", text_color="#FF5555").pack(side="left", padx=10)

    def save(self):
        if not self.last_results: return
        log_dir = os.path.join("logs", "autopentest")
        os.makedirs(log_dir, exist_ok=True)
        ts = datetime.datetime.now().strftime("%d%m%Y_%H%M%S")
        path = os.path.join(log_dir, f"audit_{ts}.txt")
        with open(path, "w") as f:
            f.write(f"TARGET: {self.last_results.get('target')}\n")
            for proto, ports in self.last_results.get('data', {}).items():
                for p in ports:
                    f.write(f"{proto} | {p['port']} | {p['state']} | {p['service']} | {p['risk']}\n")
        self.lbl_st.configure(text="GUARDADO")